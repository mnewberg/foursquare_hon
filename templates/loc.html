<Html>

<head>
	<link rel="stylesheet" href="../static/stylesheets/style.css" />
	<script src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
	<script type="text/javascript" src="../static/javascript/on_board_ui.js"></script>
			<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.18/jquery-ui.min.js" type="text/javascript"></script>
		<script src="http://fgnass.github.com/spin.js/dist/spin.min.js"></script>
		<!-- // <script type="text/javascript" src="http://code.jquery.com/mobile/1.0/jquery.mobile-1.0.min.js"></script> -->
<script src="http://code.jquery.com/mobile/1.1.1/jquery.mobile-1.1.1.js" type="text/javascript"></script>
		<script type="text/javascript" src="http://c4261091.r91.cf2.rackcdn.com/jquery.autotab-1.1b.js"></script>
		<script type="text/javascript" src="http://c4261091.r91.cf2.rackcdn.com/4sqacplugin.js"></script>
		<script src="http://js.pusher.com/1.12/pusher.min.js"></script>

		<link Href='http://fonts.googleapis.com/css?family=Lato:100,300,400,700' rel='stylesheet' type='text/css'>	
		<link rel="stylesheet" href="../static/stylesheets/jquery.mobile.structure-1.1.1.css" />

		
	<!--<link rel="stylesheet" href="http://staging.tryfourplay.com/static/css/customswatch.css" /> -->
		<meta name="viewport" content="width=device-width, initial-scale=1"> 
		<meta name="apple-touch-fullscreen" content="YES" />
		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="format-detection" content="telephone=no">
		<meta name="HandheldFriendly" content="true" />

		<!-- start Mixpanel --><script type="text/javascript">(function(d,c){var a,b,g,e;a=d.createElement("script");a.type="text/javascript";a.async=!0;a.src=("https:"===d.location.protocol?"https:":"http:")+'//api.mixpanel.com/site_media/js/api/mixpanel.2.js';b=d.getElementsByTagName("script")[0];b.parentNode.insertBefore(a,b);c._i=[];c.init=function(a,d,f){var b=c;"undefined"!==typeof f?b=c[f]=[]:f="mixpanel";g="disable track track_links track_forms register register_once unregister identify name_tag set_config".split(" ");for(e=0;e<
		g.length;e++)(function(a){b[a]=function(){b.push([a].concat(Array.prototype.slice.call(arguments,0)))}})(g[e]);c._i.push([a,d,f])};window.mixpanel=c})(document,[]);mixpanel.init("58e3c644f32d1b4f722dcf78a1e2cf58");</script><!-- end Mixpanel -->

<STYLE TYPE="text/css">

.ui-autocomplete-loading { background: white url('http://jqueryui.com/demos/autocomplete/images/ui-anim_basic_16x16.gif') right center no-repeat; }
#venue { width: 25em; }
#venue-label {
display: block;
font-weight: bold;
margin-bottom: 1em;
}
#venue-icon {
float: left;
height: 32px;
width: 32px;
vertical-align: middle;
}
#venue-address {
margin: 0;
padding: 0;
}
#venue-city {
margin: 0;
padding: 0;
}

.ui-menu-item {
min-height:40px;
}

.categoryIconContainer {
border-radius: 3px 3px 3px 3px;
    float: left;
    height: 32px;
    margin-right: 5px;
    overflow: hidden;
    width: 32px;
    vertical-align: middle;
}
.autocomplete-name {
color: #333333;
    font-weight: bold;
    font-size: 13px;
    overflow: hidden;
    text-overflow: ellipsis;
    }
.autocomplete-detail {
color: #999999;
    font-weight: normal;
    font-size: 13px;
    margin-left: 40px;
    overflow: hidden;
    text-overflow: ellipsis;
    }



.target{

margin-left:-40px;

}

.ribbon_corner{
visibility:hidden;
}

.dialog_image{
max-width:180px;
}
.poptitle{
font-size:14px;

}

#the_grid {

    line-height: 0;
    -webkit-column-count: 2;
    /*-webkit-column-gap: 10px;*/
    -moz-column-count: 2;
    /*-moz-column-gap: 10px;*/
    column-count: 2;
    column-gap: 10px;
}
/* #the_grid photo {
    width: 100% !important;
    height: auto !important;
    margin-bottom: 10px;
} */
@media (max-width: 480px) {

    #the_grid {
    -moz-column-count: 4;
    -webkit-column-count: 4;
    column-count: 4;
    }
}
@media (max-width: 320px) {
    #the_grid {
    -moz-column-count: 2;
    -webkit-column-count: 2;
    column-count: 2;
    }
}
@media screen and (max-width: 320px) {
.overflow{
width:120px;
overflow:hidden;
align:center;
}


.overflow{
         width:200px;
         overflow:hidden;

}

.dialog_image{
max-width:400px;}

.poptitle{
font-size:16px;}

.ribbon{
visibility:hidden;
}

}
#image img {
position:relative;
}

#image span {
color:white;
font: bold 12px/23px Helvetica, Sans-Serif;
background: rgba(0, 0, 0, 0.7);
padding: 10px;
position:relative;
bottom:100px;
width:100%
}

#image {
margin-bottom: -90px;
}

</style>

	     <script>
	
// $(window).scroll(function () { 
//   if ($(window).scrollTop() >= $(document).height() - $(window).height() - 100) {
// 	$('photo').fadeIn('slow')
//   }
// });

	
var pusher = new Pusher('890abd57f862ab2712ff');
var channel = pusher.subscribe('chickpix-{{token}}')
var gallerybody = ""

{% if from_4app %}
$(document).ready(function(){$.mobile.changePage('#newgallery')})
{% endif %}
channel.bind('done',function(){$('#button')[0].innerHTML='<a href=#newgallery>Ready!</a>'});
channel.bind('image',function(data){document.getElementById('the_grid').innerHTML+='<div class=photo><a href=/pickmessage?pic_id='+data["entry"][0]+'&venue_id='+data["entry"][3]+'><img src=http://img-s.foursquare.com/userpix/'+data["entry"][0]+'></a><div class=name>'+data["entry"][1]+'</div></div>'});
$('#grid').bind('click', function(){mixpanel.track('clicked-image')});

//infinite scroll
var ajaxOK = true;
$(window).on('scroll', function () {
    var yDistance = $('html, body').scrollTop();

    //here you can check how far down the user is and do your AJAX call
    if ((yDistance + $(window).height()) > ($.mobile.activePage.children('.ui-content').height() - 150)) {
        //the user is within 150px of the bottom of the page
        if (ajaxOK === true) {
            ajaxOK = false;
$.get("/getpage",function(data){alert(data.d)})
        }
    }
});

//


  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-33635510-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();



//{{sex}}

{% if lat and lon %}
var lat={{lat}}
var lon={{lon}}
$('main').ready(geo_preloaded);
{%else%}
$('main').ready(initiate_geolocation)	            
{% endif %}

function initiate_geolocation() { navigator.geolocation.getCurrentPosition(handle_geolocation_query,handle_errors);  
	        }


	        function handle_errors(error)  
	        {  
	            switch(error.code)  
	            {  
	                case error.PERMISSION_DENIED: alert("you did not share geolocation data!");  
	                break;  

	                case error.POSITION_UNAVAILABLE: alert("could not detect current position");  
	                break;  

	                case error.TIMEOUT: alert("retrieving position timed out");  
	                break;  

	                default: alert("unknown error");  
	                break;  
	            }  
	        }
					
	

	                function handle_geolocation_query(position){
	                var lat=position.coords.latitude;
	                var lon=position.coords.longitude;
                        lookup(lat,lon);
	                $.ajax({url:"/fsq",data:{'lat':lat,'lon':lon},type:"GET",timeout:100000,})}

                      function geo_preloaded(){
                         lookup(lat,lon);
                        $.ajax({url:"/fsq",data:{'lat':lat,'lon':lon},type:"GET",timeout:100000});}


    function lookup(lat,lon) {
        $("#venue").foursquareAutocomplete({
            'latitude': lat,
            'longitude': lon,
            'oauth_token': "{{token}}",
            'minLength': 3,
            'search': function (event, ui) {
                $("#venue-name").html(ui.item.name);
                $("#venue-id").val(ui.item.id);
                $("#venue-address").html(ui.item.address);
                $("#venue-cityLine").html(ui.item.cityLine);
                $("#venue-icon").attr("src", ui.item.photo);
                return false;
            },
            'onError' : function (errorCode, errorType, errorDetail) {
var message = "Foursquare Error: Code=" + errorCode + ", errorType= " + errorType + ", errorDetail= " + errorDetail;
log(message);
            }
            
        });
    };
					
$("#missingnumber").live('pageinit',function() {
$('#area_code, #number1, #number2').autotab_magic().autotab_filter('numeric');});


function submit(){ {% if not recentcheckin %}$.post('https://api.foursquare.com/v2/checkins/add',{'venueId':document.getElementById('venue-id').value,'oauth_token':'{{token}}'}){% endif %}{% if not twitter %}$.post('/updatetwitter/',{'twitter':document.getElementById('twitter').value,'csrfmiddlewaretoken':document.getElementsByName('csrfmiddlewaretoken')[0].value}){% endif %}{% if not phone %}$.post('/phone/',{'twitter':document.getElementById('phone').value,'csrfmiddlewaretoken':document.getElementsByName('csrfmiddlewaretoken')[0].value}){% endif %} }


	    </script>  
	</head>
	<body onload="setTimeout(function() { window.scrollTo(0, 1) }, 100);">
		<div data-role="page" id="main">
			<div data-role="content">	
				<header></header>
<div id="fixed_bg"></div>
				<div id="info_box">
					<div id="exclamation"></div>
					<div class="text">

<div class="info_header">Where are you?</div>
<div class="input">
	<input id="venue" />
	<div>Venue name</div>
</div>
        <input type="hidden" id="venue-id"/>
        <div id="venue-name" class="autocomplete-name"></div>
        <div id="venue-address" class="autocomplete-detail"></div>
	<div id="venue-cityLine" class="autocomplete-detail"></div>
<!-- <div><input type="submit" value="Check in!" onclick=$.post('https://api.foursquare.com/v2/checkins/add',{'venueId':document.getElementById('venue-id').value,'oauth_token':'{{token}}'})></div> -->
{% if not twitter %}
<div class="info_header">Twitter handle</div>
<div class="input">
	<input type="text" id="twitter" />
	<div>@</div>
</div>
<!-- <input type="submit" value="OK" onclick=$.post('/updatetwitter/',{'twitter':document.getElementById('twitter').value,'csrfmiddlewaretoken':document.getElementsByName('csrfmiddlewaretoken')[0].value})> -->
{% endif %}
{% csrf_token %}
</div>
<div id="button" onclick="submit()">Let's Play</div>
</div>
<div id="link"></div>
</div>

				</div>
		<div data-role="page" id="newgallery">
		  <div data-role="content" id="thegallery">
			<div id="fixed_bg"></div>
			<div id="photo_grid_wrapper">
				<header>Choose a nearby opponent</header>
				<div id="the_grid">
					</div>
					</div>
					</div>

		    </div>
</div>

		

	</body>
	
	</html>
